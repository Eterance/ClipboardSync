@page "/testhubauth"
@using Microsoft.AspNetCore.Components.Forms
@using ClipboardSync.BlazorServer.Models;
@using ClipboardSync.Common.Models;
@using Microsoft.AspNetCore.SignalR.Client;
@using ClipboardSync.Common.Services
@using System.Text.Json
@using System.Net.Http.Headers;
@inject NavigationManager Navigation
@inject IConfiguration Config
@inject AuthenticationService AuthService

<body>
    @if (_isAuth == false)
    {
        <h1>@ErrorMessage</h1>
    }
    else
    {
        <h1>@SuccessMsg</h1>
    }
</body>


@code {
    private bool _isAuth { get; set; } = false;
    private string? ErrorMessage { get; set; } = "你无权访问该页面。请重新登陆。1";
    private string? SuccessMsg { get; set; } = "你有权访问该Hub。";
    protected HubConnection? _connection;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            AuthService.ServerUrl = (Navigation.ToAbsoluteUri("")).ToString();
            var aaa = await AuthService.GetAccessTokenAsync();
            if (aaa.Item1 == false)
            {
                _isAuth = false;
                ErrorMessage = "连接至服务器出错。";
            }
            else if (aaa.Item2 == false)
            {
                _isAuth = false;
                ErrorMessage = "你无权访问该页面。请重新登陆。2";
            }
            else
            {
                var url = $"{AuthService.ServerUrl}TestAuthHub";
                _connection = new HubConnectionBuilder()
                    .WithUrl(url, options =>
                    {
                        options.AccessTokenProvider = () => Task.FromResult(aaa.Item3);
                    })
                    .WithAutomaticReconnect()
                    .Build();
                try
                {
                    await _connection.StartAsync();
                    var results = await _connection.InvokeAsync<string>("Test");
                    SuccessMsg = results;
                    _isAuth = true;
                }
                catch (Exception ex)
                {
                    _isAuth = false;
                    ErrorMessage = $"你无权访问该页面。请重新登陆。3 {ex}";
                }
            }
            StateHasChanged();
        }
        await base.OnAfterRenderAsync(firstRender);
    }
}